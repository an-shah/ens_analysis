```{r}
obj.het = readRDS('/Volumes/backup-harddrive/timecourse_object_all_HET.rds')
obj.het <- FindClusters(obj.het, resolution = 2, cluster.name = "cca_clusters.2")
obj.wt = readRDS('/Volumes/backup-harddrive/timecourse_object_all_WT.rds')
obj.het$genotype = 'Het'
obj.wt$genotype = 'WT'
```

```{r}
obj.het$type = NA
obj.het$type[obj.het$cca_clusters.2 %in% c(13)] = 'iMN_8'
obj.het$type[obj.het$cca_clusters.2 %in% c(11)] = 'iMN_9' 
obj.het$type[obj.het$cca_clusters.2 %in% c(7,14)] = 'eMN_1' 
obj.het$type[obj.het$cca_clusters.2 %in% c(9)] = 'eMN_7' 
obj.het$type[obj.het$cca_clusters.2 %in% c(6)] = 'neuroblast' 
obj.het$type[obj.het$cca_clusters.2 %in% c(0,1,2,3,4,5,8,10,12,15,16,17,18)] = 'progenitor' 
```

```{r}
DimPlot(obj.het, reduction = "umap.cca", group.by = "type")
```

```{r}
obj = merge(obj.wt, obj.het)
obj = JoinLayers(obj)

obj = split(obj, f = obj$orig.ident)
obj = NormalizeData(obj)
obj = FindVariableFeatures(obj)
obj = ScaleData(obj)
obj = RunPCA(obj)
obj <- IntegrateLayers(
  object = obj, method = CCAIntegration,
  k.weight = 50, 
  orig.reduction = "pca", new.reduction = "integrated.cca",
  verbose = FALSE
)

obj <- FindNeighbors(obj, reduction = "integrated.cca", dims = 1:30)
obj <- FindClusters(obj, resolution = 0.2, cluster.name = "cca_clusters")
obj <- RunUMAP(obj, reduction = "integrated.cca", dims = 1:30, reduction.name = "umap.cca")
```

```{r}
DimPlot(obj, reduction = "umap.cca", group.by = "genotype", shuffle = T)
```


```{r}
cluster.sample <- table(obj.wt$type, obj.wt$timepoint) %>%
    as.data.frame.matrix() %>%
    rownames_to_column(var = "sample")
  cluster.sample[-1] <- lapply(cluster.sample[-1], function(x) x/sum(x))
  cluster.sample <- cluster.sample %>%
    pivot_longer(
      cols = -c("sample"),
      names_to = "cluster",
      values_to = "count"
    )
  cluster.sample$cluster <- factor(cluster.sample$cluster, levels = unique(cluster.sample$cluster))
  cluster.sample$sample <- factor(cluster.sample$sample, levels = c('neuron', 'neuroblast', 'progenitor'))
p = ggplot(cluster.sample, aes(x=cluster, y=count, fill=sample)) +
    geom_bar(stat="identity") +
    theme_minimal()  
#ggsave(paste0('/Volumes/backup-harddrive/figures/figure 1/neuron_class_bar.svg'), plot = p)
```

```{r}
cluster.sample <- table(obj.het$type, obj.het$timepoint) %>%
    as.data.frame.matrix() %>%
    rownames_to_column(var = "sample")
  cluster.sample[-1] <- lapply(cluster.sample[-1], function(x) x/sum(x))
  cluster.sample <- cluster.sample %>%
    pivot_longer(
      cols = -c("sample"),
      names_to = "cluster",
      values_to = "count"
    )
cluster.sample$sample <- factor(
cluster.sample$sample,
  levels = c('eMN_7', 'eMN_1', 'iMN_12', 'iMN_8', 'iMN_9')
)
 cluster.sample %>% filter(is.na(cluster) | is.na(sample) | is.na(count)) %>% print()
  cluster.sample$cluster <- factor(cluster.sample$cluster, levels = unique(cluster.sample$cluster))
  #cluster.sample$sample <- factor(cluster.sample$sample, levels = c('eMN_7', 'eMN_1', 'iMN_12', 'iMN_8', 'iMN_9','neuroblast', 'progenitor' ))
p = ggplot(cluster.sample, aes(x=cluster, y=count, fill=sample)) +
    geom_bar(stat="identity", na.rm = T) +
    theme_minimal()  
print(p)
ggsave(paste0('/Volumes/backup-harddrive/figures/figure 3/neuron_class_bar.svg'), plot = p)
```


